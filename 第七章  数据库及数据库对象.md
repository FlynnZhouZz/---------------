# 7  数据库及数据库对象

## 专业术语

| 中文 | 英文 | 简称 | 说明 |
| --- | --- | --- | --- |
|  |  |  |  |

## 7.1 创建及维护数据库

数据库对象：视图、索引、存储过程、函数等

### 7.1.1 SQL Server数据库概述

SQL Server将数据库分为两大类：「系统数据库」和「用户数据库」
系统数据库：SQL Server数据库管理系统自动创建和维护的，这些数据库用于保存维护系统正常运行的信息
用户数据库：保存与用户业务有关的数据

SQL Server 2008安装好后，系统会自动安装五个数据库：「master」、「msdb」、「model」、「tempdb」、「Resource」
master: 记录SQL Server实例的「所有系统级信息」，包括：实例范围的元数据（例如登录账户）、端点、连接服务器和系统配置设置。还记录了「所有其他数据库的存在」、「数据库文件的位置」以及「SQL Server的初始化信息」
msdb: 保存关于调度报警、作业、操作员等信息
model: 用作SQL Server实例上创建的所有数据库的模板。对model数据库进行的修改（如数据库大小、排序规则、恢复模式和其他数据库选项）将应用于以后创建的所有用户数据库
tempdb: 临时数据库，用于保存临时对象或中间结果集，并为数据的排序等操作提供一个临时工作空间。每次启动SQL Server都会重新创建tempdb数据库
Resource: 只读数据库，包含了SQL Server中的所有系统对象。

### 7.1.2 SQL Server数据库的组成

SQL Server将数据库映射为一组操作系统文件，这些文件被划分为两类：「数据文件」、「日志文件」
数据文件：包含数据和对象
日志文件：包含恢复数据库中的所有事物需要的信息

**1. 数据文件**

数据文件分为：「主要数据文件」、「次要数据文件」

1. 主要数据文件: 推荐扩展名「.mdf」。它包含数据库的系统信息，也可保存用户数据。每个数据库有且只能有一个主要数据文件。主要数据文件是数据库创建的第一个数据文件。SQL Server 2008要求主要数据文件的大小不能小于2MB。
2. 次要数据文件: 推荐扩展名「.ndf」。可无也可多个次要数据文件。可建立在一个磁盘上也可建立不同的磁盘上

**2. 事务日志文件**

推荐扩展名「.ldf」。用于存放恢复数据库的所有日志信息。每个数据库必须至少有一个日志文件，也可以有多个。

**3. 数据库存储空间的分配**

数据库的空间分配规则：
1. 在创建数据库时，model数据库自动被复制到新建用户数据库中，且复制到主要数据文件中
2. SQL Server 2008中，数据的存储分配单位是「数据页（Page）」，一页是一块8KB(8 * 1024B，其中8060B存放数据，另外的132B存放系统信息)的连续磁盘空间。数据页是存储数据的最小单位，数据页的大小决定了数据表中一行数据的最大大小。
3. SQL Server不允许表中的一行数据存储在不停也上[varchar(max)/nvarchar(max)/text/ntext/varbinary(max)/image数据类型除外]，即行不能跨页存储。因此表中一行数据的大小不能超过8060B

### 7.1.3 数据库文件组

文件组的概念类似操作系统中的文件夹。
SQL Server有两种类型的文件组：「主文件组」、「用户定义的文件组」

**1. 主文件组**
主文件组(`primary`)是系统定义好的一个文件组，包含主要数据文件和任何没有明确分配给其他文件组的其他数据文件。系统表的所有页均分配在主文件组中

**2. 用户定义文件组**
用户定义文件组是通过`create database`或`alter database`语句中使用`filegroup`关键字指定的任何文件组

说明：
1. 日志文件不包括在文件组内，日志空间与数据空间是分开管理的
2. 一个文件不可以是多个文件组的成员
3. 如果文件组中有多个文件，则它们在所有文件被填满之前不会自动增长，而填满后这些文件会循环增长

默认文件组：如果在定义数据文件时没有指定其所属的文件组，则新建数据文件将被分配到默认文件组。
每个数据库只能指定一个文件组为默认文件组，SQL Server默认文件组是`primary`

### 7.1.4 数据库文件的属性

**1. 文件名及其位置**
数据库的每一个数据文件和日志文件都具有一个「逻辑文件名」和「物理文件名」

**2. 初始大小**
可以指定数据文件和日志文件的初始大小，不能小于model数据库主要数据文件的大小

**3. 增长方式**
默认配置为：自动增长

**4. 最大大小**
默认配置为：无限制

### 7.1.5 用T-SQL语句创建数据库


### 7.1.6 修改数据库

**1. 扩大数据库空间**
**2. 收缩数据库空间**
**3. 添加和删除数据库文件**

### 7.1.7 分离和附加数据库

**1. 分离数据库**
**2. 附加数据库**

## 7.2 架构

**1. 定义架构**
**2. 删除架构**

## 7.3 分区表

### 7.3.1 基本概念



### 7.3.2 创建分区表

**1. 创建分区函数**
**2. 创建分区方案**


## 7.4 索引

**1. 创建索引**
**2. 删除索引**

## 7.5 索引视图

**1. 基本概念**
**2. 定义索引视图**

