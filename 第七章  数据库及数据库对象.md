# 7  数据库及数据库对象

## 专业术语

| 中文 | 英文 | 简称 | 说明 |
| --- | --- | --- | --- |
|  |  |  |  |

## 7.1 创建及维护数据库

数据库对象：视图、索引、存储过程、函数等

### 7.1.1 SQL Server数据库概述

SQL Server将数据库分为两大类：「系统数据库」和「用户数据库」
系统数据库：SQL Server数据库管理系统自动创建和维护的，这些数据库用于保存维护系统正常运行的信息
用户数据库：保存与用户业务有关的数据

SQL Server 2008安装好后，系统会自动安装五个数据库：「master」、「msdb」、「model」、「tempdb」、「Resource」
master: 记录SQL Server实例的「所有系统级信息」，包括：实例范围的元数据（例如登录账户）、端点、连接服务器和系统配置设置。还记录了「所有其他数据库的存在」、「数据库文件的位置」以及「SQL Server的初始化信息」
msdb: 保存关于调度报警、作业、操作员等信息
model: 用作SQL Server实例上创建的所有数据库的模板。对model数据库进行的修改（如数据库大小、排序规则、恢复模式和其他数据库选项）将应用于以后创建的所有用户数据库
tempdb: 临时数据库，用于保存临时对象或中间结果集，并为数据的排序等操作提供一个临时工作空间。每次启动SQL Server都会重新创建tempdb数据库
Resource: 只读数据库，包含了SQL Server中的所有系统对象。

### 7.1.2 SQL Server数据库的组成

SQL Server将数据库映射为一组操作系统文件，这些文件被划分为两类：「数据文件」、「日志文件」
数据文件：包含数据和对象
日志文件：包含恢复数据库中的所有事物需要的信息

**1. 数据文件**

数据文件分为：「主要数据文件」、「次要数据文件」

1. 主要数据文件: 推荐扩展名「.mdf」。它包含数据库的系统信息，也可保存用户数据。每个数据库有且只能有一个主要数据文件。主要数据文件是数据库创建的第一个数据文件。SQL Server 2008要求主要数据文件的大小不能小于2MB。
2. 次要数据文件: 推荐扩展名「.ndf」。可无也可多个次要数据文件。可建立在一个磁盘上也可建立不同的磁盘上

**2. 事务日志文件**

推荐扩展名「.ldf」。用于存放恢复数据库的所有日志信息。每个数据库必须至少有一个日志文件，也可以有多个。

**3. 数据库存储空间的分配**

数据库的空间分配规则：
1. 在创建数据库时，model数据库自动被复制到新建用户数据库中，且复制到主要数据文件中
2. SQL Server 2008中，数据的存储分配单位是「数据页（Page）」，一页是一块8KB(8 * 1024B，其中8060B存放数据，另外的132B存放系统信息)的连续磁盘空间。数据页是存储数据的最小单位，数据页的大小决定了数据表中一行数据的最大大小。
3. SQL Server不允许表中的一行数据存储在不停也上[varchar(max)/nvarchar(max)/text/ntext/varbinary(max)/image数据类型除外]，即行不能跨页存储。因此表中一行数据的大小不能超过8060B

### 7.1.3 数据库文件组

文件组的概念类似操作系统中的文件夹。
SQL Server有两种类型的文件组：「主文件组」、「用户定义的文件组」

**1. 主文件组**
主文件组(`primary`)是系统定义好的一个文件组，包含主要数据文件和任何没有明确分配给其他文件组的其他数据文件。系统表的所有页均分配在主文件组中

**2. 用户定义文件组**
用户定义文件组是通过`create database`或`alter database`语句中使用`filegroup`关键字指定的任何文件组

说明：
1. 日志文件不包括在文件组内，日志空间与数据空间是分开管理的
2. 一个文件不可以是多个文件组的成员
3. 如果文件组中有多个文件，则它们在所有文件被填满之前不会自动增长，而填满后这些文件会循环增长

默认文件组：如果在定义数据文件时没有指定其所属的文件组，则新建数据文件将被分配到默认文件组。
每个数据库只能指定一个文件组为默认文件组，SQL Server默认文件组是`primary`

### 7.1.4 数据库文件的属性

**1. 文件名及其位置**
数据库的每一个数据文件和日志文件都具有一个「逻辑文件名」和「物理文件名」

**2. 初始大小**
可以指定数据文件和日志文件的初始大小，不能小于model数据库主要数据文件的大小

**3. 增长方式**
默认配置为：自动增长

**4. 最大大小**
默认配置为：无限制

### 7.1.5 用T-SQL语句创建数据库

使用T-SQL语句的`create database`创建数据库：
语法：
```sql
CAEATE DATEBASE datebase_name
    [
        ON
            [ PRIMARY ] [ <filespec> [ ,...n ]
            [ , <filegroup> [ ,...n ] ]
            [ LOG ON { <filespec> [ ,...n ] } ]
            ]
    ]
<filespec> :: = {
    (NAME = logical_file_name,
    FILENAME = { 'os_file_name' | 'filestream_path' }
    [ , SIZE = size [ KB | MB | GB | TB ] ]
    [ , MAXSIZE = { max_size [ KB | MB | GB | TB ] | UNLIMITED} ]
    [ ,FILEGROWTH = growth_increment [ KB | MB | GB | TB | % ] ]
    ) [ ,...n ]
}
<filegroup> ::= {
    FILEGROUP filegroup_name [ DEFAULT ]
    <FILESPEC> [ ,...n ]
}
```

参数解读：
1. database_name: 新数据库名
2. ON: 指定数据文件
3. PRIMARY: 指定关联数据文件的主文件组
4. LOG ON: 指定日志文件
5. <filespec>: 定义文件的属性
    > 1. NAME=logical_file_name: 指定文件的逻辑名称，唯一
    > 2. FILENAME='os_file_name': 指定操作系统（物理）文件名
    > 3. SIZE=size: 指定文件的初始大小。①没有为主要数据文件提供size，使用model数据库主要数据文件的大小；②制定了次要数据文件或日志文件，但未指定文件size，以1MB作为大小。默认单位：MB
    > 4. MAXSIZE=max_size: 指定文件可增大到的最大大小，默认单位：MB
    > 5. UNLIMITED: 指定文件的增长无限制。日志文件最大：2TB，数据文件最大：16TB
    > 6. FILEGROWTH=growth_increment: 指定文件的自动增量。growth_increment为每次为文件添加的空间量，默认单位：MB。为0表示不允许自动增加空间
6. <filegroup>: 文件组属性
    > 1. FILEGROUP filegroup_name: 文件组的逻辑名称。唯一
    > 2. DEFAULT: 指定恩建组为数据库的默认文件组


示例：
1. 创建全部使用默认值的数据库
```sql
CREATE DATABASE mytest
```

2. 创建指定一个数据文件和一个日志文件的数据库。数据库名：RShDB，该数据库由一个数据文件和一个日志文件组成。
数据文件只有主要数据文件，其逻辑文件名：RShDB_Date，物理文件名：RShDB_Data.mdf，存放在D:\RShDB_Data文件夹下，初始大小：10MB，最大大小：30MB，自动增长的递增量5MB。
日志文件的逻辑文件名为RShDB_log，物理文件名为：RShDB_log.ldf，也存放在D:\RShDB_Data文件夹下，初始大小：3MB，最大大小：12MB，自动增长时的递增量2MB。
```sql
CREATE DATABASE RShDB
ON
    (
        NAME = RShDB_data,
        FILENAME = 'D:\RShDB_Data\RShDB_Data.mdf',
        SIZE = 10,
        MAXSIZE = 30,
        FILEGROWTH = 5
    )
LOG ON
    (
        NAME = RShDB_log,
        FILENAME = 'D:\RShDB_Data\RShDB_log.ldf',
        SIZE = 3,
        MAXSIZE = 12,
        FILEGROWTH = 2,
    )
```

3. 创建具有文件组的数据库。数据库名：Sales，该数据库除了主文件组PRIMARY外，还包括SalesGroup1 和 SalesGroup2 两个文件组。
①主文件组包含Spri1_dat和SPri2_dat两个数据文件，这两个文件的FILEGROWTH均为当前文件的15%；
②SalesGroup1文件组包含SGrp1Fi1_dat 和 SGrp1Fi2_dat两个文件，两个文件的FILEGROWTH均为5MB；
③SalesGroup2文件组包含SGrp2Fi1_dat 和 SGrp2Fi2_dat两个文件，两个文件的FILEGROWTH均为5MB；
这些文件都存放在D:\Sales文件夹下，所有数据文件的初始大小为10MB，最大大小都是50MB;
该数据库只有一个日志文件Sales_log 存放在D:\Sales文件夹下，初始大小为5MB，最大大小都是25MB，每次增加5MB;

```sql
CREATE DATABASE Sales
ON PRIMARY
    (
        NAME = Spri1_dat,
        FILENAME = 'D:\Sales\Spri1_dat.mdf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 15%
    )
    (
        NAME = Spri2_dat,
        FILENAME = 'D:\Sales\Spri2_dat.Ndf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 15%
    )
FILEGROUP SalesGroup1
    (
        NAME = SGrp1Fi1_dat,
        FILENAME = 'D:\Sales\SGrp1Fi1_dat.ndf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 5
    )
    (
        NAME = SGrp1Fi2_dat,
        FILENAME = 'D:\Sales\SGrp1Fi2_dat.ndf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 5
    )
FILEGROUP SalesGroup2
    (
        NAME = SGrp2Fi1_dat,
        FILENAME = 'D:\Sales\SGrp2Fi1_dat.ndf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 5
    )
    (
        NAME = SGrp2Fi2_dat,
        FILENAME = 'D:\Sales\SGrp2Fi2_dat.ndf',
        SIZE = 10,
        MAXSIZE = 50,
        FILEGROWTH = 5
    )
LOG ON
    (
        NAME = Sales_log,
        FILENAME = 'D:\Sales\Sales_log.ldf',
        SIZE = 5,
        MAXSIZE = 25,
        FILEGROWTH = 5,
    )
```


### 7.1.6 修改数据库

**1. 扩大数据库空间**

两种方式：
1. 扩大数据库中已有的文件大小
2. 为数据库添加新的文件

示例：
1. 为RShDB数据库添加一个新的数据文件，逻辑名：RShDB_Data2，物理存储E:\Data文件夹下，物理文件名：RShDB_Data2.ndf，初始大小：6MB，不自动增长
```sql
ALTER DATABASE RShDB
ADD FILE (
    NAME = RShDB_Data2,
    FILENAME = 'E:\Data\RShDB_Data2.ndf',
    SIZE = 6,
    FILEGROWTH = 0
)
```

2. 扩大students数据库中students_data1文件的初始大小，将其初始大小改为8MB
```sql
ALTER DATABASE students
MODIFY FILE (
    NAME = students_data1,
    SIZE = 8，
)
```

3. 为RShDB数据库添加一个新的日志文件，逻辑文件名：RShDB_log1，物理存储在E:\Data文件夹下，物理文件名：RShDB_log1.ldf，初始大小：4MB，每次增加1MB，最多增加到10MB
```sql
ALTER DATABASE RShDB
ADD LOG FILE (
    NAME = RShDB_log1,
    FILENAME = 'E:\Data\RShDB_log1.ldf',
    SIZE = 4,
    FILEGROWTH = 1,
    MAXSIZE = 10,
)
```

**2. 收缩数据库空间**

收缩数据库就是释放数据库中未使用的空间，并将释放的空间交还给操作系统。
文件的收缩都是从末尾开始的。

手动收缩数据库空间分为两种情况
1. 收缩数据库中某个文件的大小
2. 按比例收缩整个数据库的大小

按比例收缩整个数据库的大小
示例：
1. 收缩Students数据库，是该数据库中所有的文件都有20%的可用空间
```sql
DBCC SHRINKDATABASE(Students, 20)
```

收缩指定文件的大小
示例：
1. 将students数据库中的students_data1文件收缩到4MB
```sql
DBCC SHRINKFILE (students_data1, 4)
```

**3. 添加和删除数据库文件**

1. 添加文件
使用ALTER DATABASE可以添加文件

2. 删除文件

示例：
1. 删除Students数据库中的students_data1文件
```sql
ALTER DATABASE Students
    REMOVE FILE students_data1
```

2. 删除Students数据库中的students_log1文件
```sql
ALTER DATABASE Students
    REMOVE FILE students_log1
```

### 7.1.7 分离和附加数据库

**1. 分离数据库**

分离数据库是将数据库从SQL Server实例中删除，但不删除数据库的数据文件和日志文件

示例：
1. 分离Students数据库，并跳过“更新统计信息”
```sql
EXEC sp_detach_db 'Students', 'true'
```

**2. 附加数据库**

附加数据库就是将分离的数据库重新附加到数据库管理系统中

`FOR ATTACH`: 指定通过附加一组现有的操作系统文件来创建数据库。必须有一个指定主要数据文件的<filespec>项
`FOR ATTACH_REBUILD_LOG`: 指定拖过附加一组现有的操作系统文件来创建数据库。该选项只限于可读/写的数据库。如果缺少日志文件，则将重新生成日志文件

示例：
1. 附加之前已分离的Students数据库
```sql
CREATE DATABASE Students
    ON (
        FILENAME = 'F:\Data\students_data1.mdf'
    )
    FOR ATTACH
```

2. 假设已对Students数据库进行了分离操作，并将其中的students_data2.ndf文件和students_log1.ldf文件均移动到了E:\NewData 文件夹下。移动数据库文件后，附加该数据库
```sql
CREATE DATABASE Students
    ON (FILENAME = 'F:\Data\students_data1.mdf'),
        (FILENAME = 'E:\NewData\students_data2.ndf'),
        (FILENAME = 'E:\NewData\students_log1.ldf')
    FOR ATTACH
```

## 7.2 架构

**1. 定义架构**
**2. 删除架构**

## 7.3 分区表

### 7.3.1 基本概念



### 7.3.2 创建分区表

**1. 创建分区函数**
**2. 创建分区方案**


## 7.4 索引

**1. 创建索引**
**2. 删除索引**

## 7.5 索引视图

**1. 基本概念**
**2. 定义索引视图**

