# 8 数据库后台编程技术

## 专业术语

| 中文 | 英文 | 简称 | 说明 |
| --- | --- | --- | --- |
|  |  |  |  |

## 8.1 存储过程

### 8.1.1 基本概念

T-SQL语言 存储和执行代码方式
1. 在客户端存储代码
2. 以子程序的形式将程序模块存储在数据库中，供有权限的用户通过调用反复执行

所谓存储过程，实际上是存储在数据库中供所有用户程序调用的子程序。

使用存储过程的好处有：
1. 允许模块化程序设计
2. 改善性能
3. 减少网络流量
4. 增强应用程序的安全性

### 8.1.2 创建、执行和删除存储过程

**1. 创建存储过程**

使用`CREATE PROCEDURE`(create procedure)语句创建

1. OUTPUT(output): 指示参数是输出参数
2. RECOMPILE(recompile): 指示数据库引擎不缓存该存储过程的计划

**2. 执行存储过程**

使用`EXEC|EXECUTE`语句执行

示例：
1. 带有复杂Select语句存储过程，建立查询地址在xx的顾客的购买情况的存储过程，列出顾客姓名、购买的商品名、单价、购买日期、会员积分数
```sql
CREATE PROCEDURE p_CustBuy1
AS
    SELECT CName,Goods那么，SalesUnitPrice，SaleDate,b.Score
    FROM Table_Customer a 
    JOIN Table_Card b ON a.CardID = b.CardID
    JOIN Table_SaleBill c ON c.CardID = b.CardID
    JOIN Table_SaleBillDetail d ON d.SaleBillID = c.SaleBillID
    JOIN Table_Goods e ON e.GoodsID = c.GoodsID
    WHERE Address = 'xx'
```

2. 带有输入参数的存储过程。建立查询地址在指定地区的顾客的购买情况的存储过程，列出顾客姓名、购买的商品名、单价、购买日期、会员积分数
```sql
CREATE PROCEDURE p_CustBuy2
    @area as varchar(20)
AS
    SELECT CName,Goods那么，SalesUnitPrice，SaleDate,b.Score
    FROM Table_Customer a 
    JOIN Table_Card b ON a.CardID = b.CardID
    JOIN Table_SaleBill c ON c.CardID = b.CardID
    JOIN Table_SaleBillDetail d ON d.SaleBillID = c.SaleBillID
    JOIN Table_Goods e ON e.GoodsID = c.GoodsID
    WHERE Address = @area
```
执行命令
```sql
EXEC p_CustBuy2 'xx'
```

3. 带有多个输入参数并有默认值的存储过程
```sql
CREATE PROCEDURE p_CustBuy3
    @area as varchar(20) = 'xx', @Price money
AS
    SELECT CName,Goods那么，SalesUnitPrice，SaleDate,b.Score
    FROM Table_Customer a 
    JOIN Table_Card b ON a.CardID = b.CardID
    JOIN Table_SaleBill c ON c.CardID = b.CardID
    JOIN Table_SaleBillDetail d ON d.SaleBillID = c.SaleBillID
    JOIN Table_Goods e ON e.GoodsID = c.GoodsID
    WHERE Address = @area AND SaleUnitPrice > @Price
```


参数传递的方式有两种
1. 按参数位置传递值
执行命令
```sql
EXEC p_CustBuy3 'XX', 1000
```
2. 按参数名传递值
执行命令
```sql
EXEC p_CustBuy3 @area='XX', @Price=1000
```

4. 带输出参数的存储过程。计算两个数的乘积，并将计算结果作为输出参数返回给调用者
```sql
CREATE PROCEDURE p_multi
    @var1 int, @var2 int, @var3 int output
AS
    SET @var3 = @var1 * @var2
```
执行存储过程
```sql
Declare @res int
EXEC Proc1 5,7,@res output
Print @res
```

5. 带输入参数和一个输出参数的存储过程。建立统计指定类型的商品的种类数的存储过程，并将统计的结果作为输出参数返回
```sql
CREATE PROCEDURE p_multi
    @class varchar(20), @count int output
AS
    SELECT @count=count(*) FROM Table_Goods a JOIN Table_GoodsClass b ON a.GoodsClassID = b.GoodsClassID
    WHERE GoodsClassName = @class
```
执行过程

```sql
Declare @res int
EXEC p_multi '服装',@res output
Print @res
```

**3. 删除存储过程**

使用语句`DROP PROCEDURE`语句进行删除操作

示例
1. 删除p_multi存储过程
```sql
DROP PROC p_multi
```

## 8.2 用户定义函数

### 8.2.1 创建和调用标量函数 
### 8.2.2 创建和调用内联表值函数
### 8.2.3 创建和调用多语句表值函数
### 8.2.4 删除用户自定义函数 

## 8.3 触发器

### 8.3.1 基本概念
### 8.3.2 创建触发器
### 8.3.3 删除触发器

## 8.4 游标

### 8.4.1 游标的组成
### 8.4.2 使用游标
### 8.4.3 游标示例
